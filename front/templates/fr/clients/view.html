{% extends "/common/layouts/base.html" %}
{% block title %}Client {{ client['name'] }} - MqttRelay{% endblock %}

{% block content %}
<h1 id="clientNameHeader" class="mb-4" style="margin-top: 50px;">Client: {{ client['name'] }}</h1>

<div id="alertContainer"></div>

<div class="row">
    <div class="col-md-4">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span>Client Details</span>
                <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#editClientModal">
                    <i class="bi bi-pencil"></i> Edit
                </button>
            </div>
            <div class="card-body">
                <p><strong>Email:</strong> <span id="clientEmail">{{ client['contact_email'] }}</span></p>
                <p><strong>Phone:</strong> <span id="clientPhone">{{ client.phone or 'N/A' }}</span></p>
                <p><strong>Joined:</strong> {{ client.created_at.strftime('%Y-%m-%d') }}</p>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-info text-white">
                Client Dashboard
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <h5>Total data points</h5>
                        <p class="display-5">{{ client_stats['total_messages'] }}</p>
                        <i class="bi bi-clipboard-data text-info fs-2"></i>
                    </div>
                    <div class="col-4">
                        <h5>Latest data point</h5>
                        <p class="display-5 relative-time-displayer" data-time="{{ client_stats['lastest_message'] if client_stats['lastest_message'] else '-' }}" title="{{ client_stats['lastest_message'] if client_stats['lastest_message'] else '' }}">{{ '' if client_stats['lastest_message'] else "No Data yet" }}</p>
                        <i class="bi bi-clock text-success fs-2"></i>
                    </div>
                    <div class="col-4">
                        <h5>Availability</h5>
                        <p class="display-5">{{ (client_stats['availability'] or "-").__str__()[:4]+'%' }}</p>
                        <i class="bi bi-receipt text-warning fs-2"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Devices card -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <span>Devices</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="devicesTable">
                        <thead>
                            <tr>
                                <th style="width: 80px;">ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Last Data</th>
                                <th>Availability</th>
                                <th class="text-end" style="width: 140px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for d in devices %}
                            <tr id="device-row-{{ d['id'] }}">
                                <td>#{{ d['id'] }}</td>
                                <td class="dev-name">{{ d['name'] or '-' }}</td>
                                <td class="dev-type">
                                    {% if d['vendor'] %}
                                        <span class="dev-type-label">{{ d['vendor'] }} {{ d['model'] }} ({{ d['kind'] }})</span>
                                    {% else %}
                                        <span class="dev-type-label">Type #{{ d['device_type_id'] }}</span>
                                    {% endif %}
                                </td>
                                <td class="dev-ext relative-time-displayer" data-time="{{ client_stats['devices'].get(d['id'],{}).get('last_message') or '-' }}" title="{{ client_stats['devices'].get(d['id'],{}).get('last_message') or '' }}">{{ '' if client_stats['devices'].get(d['id'],{}).get('last_message') else '-' }}</td>
                                <td class="dev-created">{{ (client_stats['devices'].get(d['id'],{}).get('availability') or '-').__str__()[:4]+'%' }}</td>
                                <td class="text-end">
                                    <button
                                      class="btn btn-sm btn-outline-primary view-device-btn me-1"
                                      title="View / Edit device"
                                      data-device-id="{{ d['id'] }}"
                                      data-view-url="{{ url_for('clients.getDevice', client_id=client['id'], device_id=d['id'], json=True) }}"
                                      data-update-url="{{ url_for('clients.editDevice', client_id=client['id'], device_id=d['id']) }}">
                                      <i class="bi bi-eye"></i>
                                    </button>
                                    <button
                                      class="btn btn-sm btn-outline-danger delete-device-btn"
                                      title="Delete device"
                                      data-device-id="{{ d['id'] }}"
                                      data-delete-url="{{ url_for('clients.deleteDevice', client_id=client['id'], device_id=d['id']) }}">
                                      <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">No devices yet.</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Add button below the table -->
                <div class="d-flex justify-content-end">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                        <i class="bi bi-plus-circle"></i> Add Device
                    </button>
                </div>
            </div>
        </div>
        <!-- /Devices card -->

        <!-- Client Destinations card -->
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <span>Client Destinations</span>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle" id="destinationsTable">
                <thead>
                  <tr>
                    <th style="width:80px;">ID</th>
                    <th>Type</th>
                    <th>Target</th>
                    <th>Active</th>
                    <th class="text-end" style="width:140px;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                {% for dest in destinations or [] %}
                  <tr id="dest-row-{{ dest['id'] }}">
                    <td>#{{ dest['id'] }}</td>
                    <td class="dest-type">{{ dest['type'].name.lower() }}</td>
                    <td class="dest-target">
                      {% if dest['type'].name.lower() in ['mysql','postgres'] %}
                        {{ (dest['host'] or '-') ~ (':' ~ dest['port'] if dest['port'] else '') ~ ('/' ~ dest['database_name'] if dest['database_name'] else '') }}
                      {% elif dest['type'] in ['http','kafka','file','other'] %}
                        {{ dest['uri'] or '-' }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td class="dest-active">
                      {% if dest['active'] %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-secondary">Inactive</span>{% endif %}
                    </td>
                    <td class="text-end">
                      <button
                        class="btn btn-sm btn-outline-primary view-dest-btn me-1"
                        title="View / Edit destination"
                        data-dest-id="{{ dest['id'] }}"
                        data-view-url="{{ url_for('clients.getDestination', client_id=client['id'], destination_id=dest['id'], json=True) }}"
                        data-update-url="{{ url_for('clients.editDestination', client_id=client['id'], destination_id=dest['id']) }}">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-outline-danger delete-dest-btn"
                        title="Delete destination"
                        data-dest-id="{{ dest['id'] }}"
                        data-delete-url="{{ url_for('clients.deleteDestination', client_id=client['id'], destination_id=dest['id']) }}">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="5" class="text-center text-muted">No destinations yet.</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-end">
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDestinationModal">
                <i class="bi bi-plus-circle"></i> Add Destination
              </button>
            </div>
          </div>
        </div>
        <!-- /Client Destinations card -->

    </div>
</div>

<a href="{{ url_for('clients.listClients') }}" class="btn btn-secondary">
    <i class="bi bi-arrow-left"></i> Back to Clients
</a>

<!-- Edit Client Modal -->
<div class="modal fade" id="editClientModal" tabindex="-1" aria-labelledby="editClientLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="editClientForm">
      <div class="modal-header">
        <h5 class="modal-title" id="editClientLabel">Edit Client</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <input type="hidden" name="client_id" value="{{ client['id'] }}">

          <div class="mb-3">
              <label for="name" class="form-label">Name</label>
              <input name="name" id="name" class="form-control" value="{{ client['name'] }}" required>
          </div>

          <div class="mb-3">
              <label for="contact_email" class="form-label">Email</label>
              <input type="email" name="contact_email" id="contact_email" class="form-control" value="{{ client['contact_email'] or '' }}">
          </div>

          <div class="mb-3">
              <label for="phone" class="form-label">Phone</label>
              <input type="tel" name="phone" id="phone" class="form-control" value="{{ client.phone or '' }}">
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="saveEditBtn" type="submit" class="btn btn-primary">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Save changes
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1" aria-labelledby="addDeviceLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="addDeviceForm">
      <div class="modal-header">
        <h5 class="modal-title" id="addDeviceLabel">Add Device</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="client_id" value="{{ client['id'] }}">
        <div class="mb-3">
          <label for="device_type_id" class="form-label">Device Type</label>
          <select id="device_type_id" name="device_type_id" class="form-select" required>
            <option value="" selected disabled>Loading device types…</option>
          </select>
          <div class="form-text">Types are fetched from <code>devices.listDevices</code>.</div>
        </div>
        <div class="mb-3">
          <label for="device_name" class="form-label">Name</label>
          <input id="device_name" name="name" class="form-control" placeholder="e.g., Soil Sensor #1" required>
        </div>
        <div class="mb-3">
          <label for="external_ref" class="form-label">External Ref</label>
          <input id="external_ref" name="external_ref" class="form-control" placeholder="Vendor serial / custom id">
        </div>
        <div class="mb-3">
          <label for="topic" class="form-label">Topic</label>
          <input id="topic" name="topic" class="form-control" placeholder="e.g., sensors/field-1/lse01/123456">
        </div>

        <div class="row g-3">
          <div class="col-sm-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="installed" name="installed">
              <label class="form-check-label" for="installed">Installed</label>
            </div>
          </div>
          <div class="col-sm-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="working" name="working">
              <label class="form-check-label" for="working">Working</label>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <label for="emission_rate_seconds" class="form-label">Emission Rate (seconds)</label>
          <input type="number" min="0" step="1" id="emission_rate_seconds" name="emission_rate_seconds" class="form-control" placeholder="e.g., 300">
        </div>

        <div class="mt-3">
          <label for="metadata_json" class="form-label">Metadata (JSON, optional)</label>
          <textarea id="metadata_json" name="metadata_json" class="form-control" rows="3" placeholder='{"location":"north field"}'></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="saveDeviceBtn" type="submit" class="btn btn-success">
          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          Add Device
        </button>
      </div>
    </form>
  </div>
</div>


<!-- View / Edit Device Modal -->
<div class="modal fade" id="deviceDetailsModal" tabindex="-1" aria-labelledby="deviceDetailsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deviceDetailsLabel">Device #<span id="dd_id"></span> – <span id="dd_name"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-details" data-bs-toggle="tab" data-bs-target="#pane-details" type="button" role="tab">Details</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-edit" data-bs-toggle="tab" data-bs-target="#pane-edit" type="button" role="tab">Edit</button>
          </li>
        </ul>
        <div class="tab-content pt-3">
          <!-- Details pane -->
          <div class="tab-pane fade show active" id="pane-details" role="tabpanel" aria-labelledby="tab-details">
            <div class="row g-3">
              <div class="col-md-6">
                <div><strong>Type:</strong> <span id="dd_type"></span></div>
                <div><strong>Device Type ID:</strong> <span id="dd_device_type_id"></span></div>
                <div><strong>External Ref:</strong> <span id="dd_external_ref"></span></div>
                <div><strong>Topic:</strong> <code id="dd_topic"></code></div>
                <div><strong>Emission Rate (s):</strong> <span id="dd_emission_rate_seconds"></span></div>
              </div>
              <div class="col-md-6">
                <div><strong>Installed:</strong> <span id="dd_installed"></span></div>
                <div><strong>Working:</strong> <span id="dd_working"></span></div>
                <div><strong>Created:</strong> <span id="dd_created_at"></span></div>
              </div>
              <div class="col-12">
                <label class="form-label">Metadata</label>
                <pre class="bg-light p-3 rounded small mb-0" id="dd_metadata" style="max-height: 240px; overflow:auto;">—</pre>
              </div>
            </div>
          </div>
          <!-- Edit pane -->
          <div class="tab-pane fade" id="pane-edit" role="tabpanel" aria-labelledby="tab-edit">
            <form id="editDeviceForm">
              <input type="hidden" id="edf_device_id">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="edf_device_type_id">Device Type</label>
                  <select id="edf_device_type_id" class="form-select" required>
                    <option value="" selected disabled>Loading device types…</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="edf_name">Name</label>
                  <input id="edf_name" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="edf_external_ref">External Ref</label>
                  <input id="edf_external_ref" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="edf_topic">Topic</label>
                  <input id="edf_topic" class="form-control" placeholder="sensors/field-1/...">
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="edf_emission_rate_seconds">Emission Rate (seconds)</label>
                  <input type="number" min="0" step="1" id="edf_emission_rate_seconds" class="form-control" placeholder="e.g., 300">
                </div>
                <div class="col-md-6 d-flex align-items-center">
                  <div class="form-check me-4">
                    <input class="form-check-input" type="checkbox" id="edf_installed">
                    <label class="form-check-label" for="edf_installed">Installed</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="edf_working">
                    <label class="form-check-label" for="edf_working">Working</label>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label" for="edf_metadata_json">Metadata (JSON)</label>
                  <textarea id="edf_metadata_json" class="form-control" rows="6" placeholder='{"location":"north field"}'></textarea>
                </div>
              </div>
              <div class="mt-3 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary" id="edf_saveBtn">
                  <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div> <!-- /tab-content -->
      </div>
    </div>
  </div>
</div>

<!-- Add Destination Modal -->
<div class="modal fade" id="addDestinationModal" tabindex="-1" aria-labelledby="addDestinationLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="addDestinationForm">
      <div class="modal-header">
        <h5 class="modal-title" id="addDestinationLabel">Add Destination</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="client_id" value="{{ client['id'] }}">

        <div class="mb-3">
          <label for="dest_type" class="form-label">Type</label>
          <select id="dest_type" name="type" class="form-select" required>
            <option value="" selected disabled>Select a type</option>
            <option value="mysql">MySQL</option>
            <option value="postgres">Postgres</option>
            <option value="http">HTTP</option>
            <option value="kafka">Kafka</option>
            <option value="file">File</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="row g-3 db-only d-none">
          <div class="col-sm-8">
            <label for="dest_host" class="form-label">Host</label>
            <input id="dest_host" name="host" class="form-control" placeholder="db.example.com">
          </div>
          <div class="col-sm-4">
            <label for="dest_port" class="form-label">Port</label>
            <input id="dest_port" name="port" type="number" min="0" step="1" class="form-control" placeholder="3306">
          </div>
          <div class="col-sm-12">
            <label for="dest_database_name" class="form-label">Database</label>
            <input id="dest_database_name" name="database_name" class="form-control" placeholder="mydb">
          </div>
          <div class="col-sm-6">
            <label for="dest_username" class="form-label">Username</label>
            <input id="dest_username" name="username" class="form-control" placeholder="dbuser">
          </div>
          <div class="col-sm-6">
            <label for="dest_password" class="form-label">Password</label>
            <input id="dest_password" name="password" type="password" class="form-control" placeholder="••••••••">
            <div class="form-text">Stored encrypted server-side.</div>
          </div>
        </div>

        <div class="mb-3 uri-only d-none">
          <label for="dest_uri" class="form-label">URI / Endpoint</label>
          <input id="dest_uri" name="uri" class="form-control" placeholder="https://api.example.com/ingest">
        </div>

        <div class="mb-3">
          <label for="dest_options_json" class="form-label">Options (JSON)</label>
          <textarea id="dest_options_json" name="options_json" rows="4" class="form-control" placeholder='{"ssl": true, "table": "measurements"}'></textarea>
        </div>

        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="dest_active" name="active" checked>
          <label class="form-check-label" for="dest_active">Active</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="saveDestinationBtn" type="submit" class="btn btn-success">
          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          Add Destination
        </button>
      </div>
    </form>
  </div>
</div>

<!-- View / Edit Destination Modal -->
<div class="modal fade" id="destinationDetailsModal" tabindex="-1" aria-labelledby="destinationDetailsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="destinationDetailsLabel">Destination #<span id="vd_id"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="vd-tab-details" data-bs-toggle="tab" data-bs-target="#vd-pane-details" type="button" role="tab">Details</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="vd-tab-edit" data-bs-toggle="tab" data-bs-target="#vd-pane-edit" type="button" role="tab">Edit</button>
          </li>
        </ul>

        <div class="tab-content pt-3">
          <!-- Details -->
          <div class="tab-pane fade show active" id="vd-pane-details" role="tabpanel" aria-labelledby="vd-tab-details">
            <div class="row g-3">
              <div class="col-md-6">
                <div><strong>Type:</strong> <span id="vd_type"></span></div>
                <div><strong>Target:</strong> <span id="vd_target"></span></div>
                <div><strong>Active:</strong> <span id="vd_active"></span></div>
                <div><strong>Created:</strong> <span id="vd_created_at"></span></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Options</label>
                <pre class="bg-light p-3 rounded small mb-0" id="vd_options" style="max-height: 240px; overflow:auto;">—</pre>
              </div>
            </div>
          </div>

          <!-- Edit -->
          <div class="tab-pane fade" id="vd-pane-edit" role="tabpanel" aria-labelledby="vd-tab-edit">
            <form id="editDestinationForm">
              <input type="hidden" id="vdf_id">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="vdf_type">Type</label>
                  <select id="vdf_type" class="form-select" required>
                    <option value="mysql">MySQL</option>
                    <option value="postgres">Postgres</option>
                    <option value="http">HTTP</option>
                    <option value="kafka">Kafka</option>
                    <option value="file">File</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <div class="col-md-6 d-flex align-items-end">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="vdf_active">
                    <label class="form-check-label" for="vdf_active">Active</label>
                  </div>
                </div>

                <!-- DB cluster -->
                <div class="col-md-8 db-only-edit d-none">
                  <label class="form-label" for="vdf_host">Host</label>
                  <input id="vdf_host" class="form-control" placeholder="db.example.com">
                </div>
                <div class="col-md-4 db-only-edit d-none">
                  <label class="form-label" for="vdf_port">Port</label>
                  <input id="vdf_port" type="number" min="0" step="1" class="form-control" placeholder="5432">
                </div>
                <div class="col-md-6 db-only-edit d-none">
                  <label class="form-label" for="vdf_database_name">Database</label>
                  <input id="vdf_database_name" class="form-control" placeholder="mydb">
                </div>
                <div class="col-md-6 db-only-edit d-none">
                  <label class="form-label" for="vdf_username">Username</label>
                  <input id="vdf_username" class="form-control" placeholder="dbuser">
                </div>
                <div class="col-md-6 db-only-edit d-none">
                  <label class="form-label" for="vdf_password">Password</label>
                  <input id="vdf_password" type="password" class="form-control" placeholder="(leave blank to keep)">
                </div>

                <!-- URI -->
                <div class="col-12 uri-only-edit d-none">
                  <label class="form-label" for="vdf_uri">URI / Endpoint</label>
                  <input id="vdf_uri" class="form-control" placeholder="https://api.example.com/ingest">
                </div>

                <div class="col-12">
                  <label class="form-label" for="vdf_options_json">Options (JSON)</label>
                  <textarea id="vdf_options_json" class="form-control" rows="6" placeholder='{"headers":{"Authorization":"Bearer ..."}}'></textarea>
                </div>
              </div>

              <div class="mt-3 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary" id="vdf_saveBtn">
                  <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div> <!-- /tab-content -->
      </div>
    </div>
  </div>
</div>


<script>
// ---------- Helpers ----------
function showAlert(message, variant='success') {
  const container = document.getElementById('alertContainer');
  container.innerHTML = `
    <div class="alert alert-${variant} alert-dismissible fade show" role="alert">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
}
function safeJsonParse(text) {
  if (!text || !text.trim()) return null;
  try { return JSON.parse(text); } catch (e) { throw new Error('Invalid JSON'); }
}
function pretty(obj) {
  try { return JSON.stringify(obj, null, 2); } catch { return String(obj ?? ''); }
}
function boolBadge(v){
  const truthy = (v===true || v===1 || v==="1" || v==="true" || v==="True");
  return truthy ? '<span class="badge bg-success"><i class="bi bi-check2"></i> Yes</span>'
                : '<span class="badge bg-secondary">No</span>';
}
function deviceRowHTMLPartialUpdate(rowEl, device, typeLabel) {
  if (!rowEl) return;
  if (device.name !== undefined) rowEl.querySelector('.dev-name').textContent = device.name || '-';
  if (device.external_ref !== undefined) rowEl.querySelector('.dev-ext').textContent = device.external_ref || '-';
  if (device.emission_rate_seconds !== undefined || device.emission_rate !== undefined) {
    const val = device.emission_rate_seconds ?? device.emission_rate ?? '-';
    rowEl.querySelector('.dev-emit').textContent = (val === null || val === undefined || val === '') ? '-' : val;
  }
  if (typeLabel) rowEl.querySelector('.dev-type .dev-type-label').textContent = typeLabel;
}

// ---------- CSRF & headers ----------
(function initCommonHeaders(){
  const metaCsrf = document.querySelector('meta[name="csrf-token"]');
  const metaVal = metaCsrf ? metaCsrf.getAttribute('content') : "";
  const jinjaVal = {% if csrf_token is defined %}"{{ csrf_token() }}"{% else %}""{% endif %};
  const csrfToken = metaVal || jinjaVal || "";
  window._commonHeaders = { 'Content-Type': 'application/json' };
  if (csrfToken) window._commonHeaders['X-CSRFToken'] = csrfToken;
})();

// ---------- Client edit ----------
document.getElementById('editClientForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target, btn = document.getElementById('saveEditBtn'), spinner = btn.querySelector('.spinner-border');
  btn.disabled = true; spinner.classList.remove('d-none');
  const payload = {
    id: form.client_id.value,
    name: form.name.value.trim(),
    contact_email: form.contact_email.value.trim(),
    phone: form.phone.value.trim()
  };
  const url = "{{ url_for('clients.editClient', client_id=client['id']) }}";
  try {
    const res = await fetch(url, { method: 'PUT', headers: window._commonHeaders, body: JSON.stringify(payload) });
    const data = await res.json().catch(()=>({}));
    if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
    const updated = data.client || payload;
    document.getElementById('clientNameHeader').textContent = `Client: ${updated.name}`;
    document.getElementById('clientEmail').textContent = updated.contact_email || '';
    document.getElementById('clientPhone').textContent = updated.phone || 'N/A';
    document.title = `Client ${updated.name} - MqttRelay`;
    (bootstrap.Modal.getInstance(editClientModal) || new bootstrap.Modal(editClientModal)).hide();
    showAlert('Client updated successfully.');
  } catch (err) {
    showAlert('Failed to update client: ' + err.message, 'danger');
  } finally {
    btn.disabled = false; spinner.classList.add('d-none');
  }
});

// ---------- Device types cache (used by both Add and Edit) ----------
let deviceTypesCache = null;
async function loadDeviceTypesOnce() {
  if (deviceTypesCache) return deviceTypesCache;
  const url = "{{ url_for('devices.listDevices', json=True) }}";
  const res = await fetch(url, { headers: window._commonHeaders });
  const data = await res.json().catch(()=> ({}));
  if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
  const list = data.device_types || data || [];
  deviceTypesCache = list.map(t => ({
    id: t.id ?? t['id'],
    vendor: t.vendor ?? t['vendor'] ?? '',
    model: t.model ?? t['model'] ?? '',
    kind: t.kind ?? t['kind'] ?? ''
  }));
  return deviceTypesCache;
}
function typeLabelFor(id){
  if (!deviceTypesCache) return null;
  const t = deviceTypesCache.find(x => String(x.id) === String(id));
  return t ? `${t.vendor} ${t.model} (${t.kind})` : null;
}

// ---------- Add device ----------
const addDeviceModal = document.getElementById('addDeviceModal');
addDeviceModal.addEventListener('show.bs.modal', async () => {
  const sel = document.getElementById('device_type_id');
  if (sel.dataset.loaded === '1') return;
  try {
    const types = await loadDeviceTypesOnce();
    sel.innerHTML = '<option value="" selected disabled>Select a device type</option>' +
      types.map(t => `<option value="${t.id}">${t.vendor} ${t.model} (${t.kind})</option>`).join('');
    sel.dataset.loaded = '1';
  } catch (err) {
    sel.innerHTML = '<option value="" selected disabled>Failed to load device types</option>';
    showAlert('Failed to load device types: ' + err.message, 'danger');
  }
});
document.getElementById('addDeviceForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target, btn = document.getElementById('saveDeviceBtn'), spinner = btn.querySelector('.spinner-border');
  btn.disabled = true; spinner.classList.remove('d-none');
  try {
    const eraw = form.emission_rate_seconds.value.trim();
    const payload = {
      client_id: parseInt(form.client_id.value, 10),
      device_type_id: parseInt(form.device_type_id.value, 10),
      name: form.device_name.value.trim(),
      external_ref: form.external_ref.value.trim(),
      topic: form.topic.value.trim(),
      installed: !!form.installed.checked,
      working: !!form.working.checked,
      emission_rate_seconds: eraw === '' ? null : parseInt(eraw, 10),
      metadata_json: safeJsonParse(form.metadata_json.value)
    };
    const url = "{{ url_for('clients.addDevice', client_id=client['id']) }}";
    const res = await fetch(url, { method: 'POST', headers: window._commonHeaders, body: JSON.stringify(payload) });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
    const device = data.device || data || payload;
    if (!device.id) device.id = Math.floor(Math.random()*1e9);
    const tLabel = typeLabelFor(device.device_type_id) || (device.device_type_label || `Type #${device.device_type_id}`);
    const rowHTML = `
      <tr id="device-row-${device.id}">
        <td>#${device.id}</td>
        <td class="dev-name">${device.name || '-'}</td>
        <td class="dev-type"><span class="dev-type-label">${tLabel}</span></td>
        <td class="dev-ext">${device.external_ref || '-'}</td>
        <td class="dev-emit">${(emitVal === null || emitVal === undefined || emitVal === '') ? '-' : emitVal}</td>
        <td class="dev-created">${device.created_at ? String(device.created_at).slice(0,10) : '-'}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary view-device-btn me-1"
            title="View / Edit device"
            data-device-id="${device.id}"
            data-view-url="${"{{ url_for('clients.getDevice', client_id=client['id'], device_id=0, json=True) }}".replace('device_id=0','device_id='+device.id)}"
            data-update-url="${"{{ url_for('clients.editDevice', client_id=client['id'], device_id=0) }}".replace('device_id=0','device_id='+device.id)}">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger delete-device-btn" title="Delete device"
            data-device-id="${device.id}"
            data-delete-url="${"{{ url_for('clients.deleteDevice', client_id=client['id'], device_id=0) }}".replace('device_id=0','device_id='+device.id)}">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>`;
    const tbody = document.querySelector('#devicesTable tbody');
    if (tbody.querySelector('.text-muted')) tbody.innerHTML = '';
    tbody.insertAdjacentHTML('afterbegin', rowHTML);
    bindDeleteHandlers(tbody);
    bindViewHandlers(tbody);
    (bootstrap.Modal.getInstance(addDeviceModal) || new bootstrap.Modal(addDeviceModal)).hide();
    form.reset();
    showAlert('Device added successfully.');
  } catch (err) {
    showAlert('Failed to add device: ' + err.message, 'danger');
  } finally {
    btn.disabled = false; spinner.classList.add('d-none');
  }
});

// ---------- Delete device ----------
function bindDeleteHandlers(root=document) {
  root.querySelectorAll('.delete-device-btn').forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute('data-device-id');
      const url = btn.getAttribute('data-delete-url');
      if (!confirm(`Delete device #${id}? This cannot be undone.`)) return;
      btn.disabled = true;
      try {
        const res = await fetch(url, { method: 'DELETE', headers: window._commonHeaders });
        const data = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
        const row = document.getElementById(`device-row-${id}`);
        row?.parentNode?.removeChild(row);
        const tbody = document.querySelector('#devicesTable tbody');
        if (tbody && !tbody.querySelector('tr')) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No devices yet.</td></tr>`;
        }
        showAlert(`Device #${id} deleted successfully.`);
      } catch (err) {
        showAlert('Failed to delete device: ' + err.message, 'danger');
      } finally {
        btn.disabled = false;
      }
    };
  });
}

// ---------- View/Edit device ----------
const deviceDetailsModal = document.getElementById('deviceDetailsModal');
const editDeviceForm = document.getElementById('editDeviceForm');

async function ensureEditTypeSelectLoaded() {
  const sel = document.getElementById('edf_device_type_id');
  if (sel.dataset.loaded === '1') return;
  const types = await loadDeviceTypesOnce();
  sel.innerHTML = '<option value="" disabled>Select a device type</option>' +
    types.map(t => `<option value="${t.id}">${t.vendor} ${t.model} (${t.kind})</option>`).join('');
  sel.dataset.loaded = '1';
}

function fillDeviceDetails(d){
  document.getElementById('dd_id').textContent = d.id ?? '';
  document.getElementById('dd_name').textContent = d.name || '-';
  const typeStr = d.vendor ? `${d.vendor} ${d.model} (${d.kind})`
                : (typeLabelFor(d.device_type_id) || `Type #${d.device_type_id}`);
  document.getElementById('dd_type').textContent = typeStr || '-';
  document.getElementById('dd_device_type_id').textContent = d.device_type_id ?? (d.device_type && d.device_type.id) ?? '-';
  document.getElementById('dd_external_ref').textContent = d.external_ref || '-';
  document.getElementById('dd_topic').textContent = d.topic || '';
  document.getElementById('dd_installed').innerHTML = boolBadge(d.installed);
  document.getElementById('dd_working').innerHTML = boolBadge(d.working);
  document.getElementById('dd_created_at').textContent = d.created_at ? String(d.created_at).slice(0,10) : '-';
  document.getElementById('dd_metadata').textContent = pretty(d.metadata_json ?? d.metadata ?? null) || '—';
}


function fillEditForm(d, updateUrl){
  document.getElementById('edf_device_id').value = d.id ?? '';
  document.getElementById('edf_name').value = d.name || '';
  document.getElementById('edf_external_ref').value = d.external_ref || '';
  document.getElementById('edf_topic').value = d.topic || '';
  document.getElementById('edf_emission_rate_seconds').value = (d.emission_rate_seconds ?? d.emission_rate ?? '') || '';
  document.getElementById('edf_installed').checked = (d.installed===true || d.installed===1 || d.installed==="1" || d.installed==="true");
  document.getElementById('edf_working').checked = (d.working===true || d.working===1 || d.working==="1" || d.working==="true");
  document.getElementById('edf_metadata_json').value = pretty(d.metadata_json ?? d.metadata ?? null);
  const sel = document.getElementById('edf_device_type_id');
  sel.value = String(d.device_type_id ?? (d.device_type && d.device_type.id) ?? '');
  editDeviceForm.dataset.updateUrl = updateUrl;
}

function bindViewHandlers(root=document){
  root.querySelectorAll('.view-device-btn').forEach(btn => {
    btn.onclick = async () => {
      const viewUrl = btn.getAttribute('data-view-url');
      const updateUrl = btn.getAttribute('data-update-url');
      try {
        await ensureEditTypeSelectLoaded();
        const res = await fetch(viewUrl, { headers: window._commonHeaders });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
        const d = data.device || data; // accept both shapes
        fillDeviceDetails(d);
        fillEditForm(d, updateUrl);
        new bootstrap.Modal(deviceDetailsModal).show();
      } catch (err) {
        showAlert('Failed to load device: ' + err.message, 'danger');
      }
    };
  });
}
bindViewHandlers(document);

// Save edits
editDeviceForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const btn = document.getElementById('edf_saveBtn');
  const spinner = btn.querySelector('.spinner-border');
  btn.disabled = true; spinner.classList.remove('d-none');

  try {
    const eraw = document.getElementById('edf_emission_rate_seconds').value.trim();
    const payload = {
      name: document.getElementById('edf_name').value.trim(),
      device_type_id: parseInt(document.getElementById('edf_device_type_id').value,10),
      external_ref: document.getElementById('edf_external_ref').value.trim(),
      topic: document.getElementById('edf_topic').value.trim(),
      emission_rate: eraw === '' ? null : parseInt(eraw, 10),
      installed: !!document.getElementById('edf_installed').checked,
      working: !!document.getElementById('edf_working').checked,
      metadata_json: safeJsonParse(document.getElementById('edf_metadata_json').value)
    };
    const url = editDeviceForm.dataset.updateUrl;
    const res = await fetch(url, { method: 'PUT', headers: window._commonHeaders, body: JSON.stringify(payload) });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);

    const updated = data.device || { id: document.getElementById('edf_device_id').value, ...payload };
    // Update modal details and table row
    fillDeviceDetails(updated);
    const row = document.getElementById(`device-row-${updated.id}`);
    const tLabel = typeLabelFor(updated.device_type_id) || `Type #${updated.device_type_id}`;
    deviceRowHTMLPartialUpdate(row, updated, tLabel);

    showAlert('Device updated successfully.');
    // Switch back to details tab
    document.querySelector('#tab-details').click();
  } catch (err) {
    showAlert('Failed to update device: ' + err.message, 'danger');
  } finally {
    btn.disabled = false; spinner.classList.add('d-none');
  }
});

// Initial bindings
bindDeleteHandlers(document);
</script>

<script>
// ======= Destinations helpers =======
function formatDestTarget(d) {
  console.log(d.type)
  const t = (d.type || '').toLowerCase();
  if (t === 'mysql' || t === 'postgres') {
    const host = d.host || '-';
    const port = d.port ? `:${d.port}` : '';
    const db   = d.database_name ? `/${d.database_name}` : '';
    return `${host}${port}${db}`;
  }
  return d.uri || '-';
}
function activeBadge(v){
  const on = (v===true || v===1 || v==="1" || v==="true" || v==="True");
  return on ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';
}
function showDbCluster(containerSelector, show){
  document.querySelectorAll(containerSelector).forEach(el => el.classList.toggle('d-none', !show));
}
function showUriCluster(containerSelector, show){
  document.querySelectorAll(containerSelector).forEach(el => el.classList.toggle('d-none', !show));
}
function toggleAddClusters() {
  const t = (document.getElementById('dest_type').value || '').toLowerCase();
  const isDb = (t==='mysql' || t==='postgres');
  const isUri = (t==='http' || t==='kafka' || t==='file' || t==='other');
  showDbCluster('.db-only', isDb);
  showUriCluster('.uri-only', isUri);
}
function toggleEditClusters() {
  const t = (document.getElementById('vdf_type').value || '').toLowerCase();
  const isDb = (t==='mysql' || t==='postgres');
  const isUri = (t==='http' || t==='kafka' || t==='file' || t==='other');
  showDbCluster('.db-only-edit', isDb);
  showUriCluster('.uri-only-edit', isUri);
}
document.getElementById('dest_type').addEventListener('change', toggleAddClusters);

// ======= Add destination =======
const addDestinationModal = document.getElementById('addDestinationModal');
document.getElementById('addDestinationForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target, btn = document.getElementById('saveDestinationBtn'), spinner = btn.querySelector('.spinner-border');
  btn.disabled = true; spinner.classList.remove('d-none');

  try {
    const payload = {
      client_id: parseInt(form.client_id.value,10),
      type: form.dest_type.value,
      host: form.dest_host.value.trim() || null,
      port: form.dest_port.value ? parseInt(form.dest_port.value,10) : null,
      database_name: form.dest_database_name.value.trim() || null,
      username: form.dest_username.value.trim() || null,
      password: form.dest_password.value, // plaintext; server should encrypt into password_enc
      uri: form.dest_uri.value.trim() || null,
      options_json: safeJsonParse(form.dest_options_json.value),
      active: !!form.dest_active.checked
    };
    const url = "{{ url_for('clients.addDestination', client_id=client['id']) }}";
    const res = await fetch(url, { method:'POST', headers: window._commonHeaders, body: JSON.stringify(payload) });
    const data = await res.json().catch(()=>({}));
    if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);

    const dest = data.destination || data || payload;
    if (!dest.id) dest.id = Math.floor(Math.random()*1e9);

    const rowHTML = `
      <tr id="dest-row-${dest.id}">
        <td>#${dest.id}</td>
        <td class="dest-type">${dest.type}</td>
        <td class="dest-target">${formatDestTarget(dest)}</td>
        <td class="dest-active">${activeBadge(dest.active)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary view-dest-btn me-1"
            title="View / Edit destination"
            data-dest-id="${dest.id}"
            data-view-url="${"{{ url_for('clients.getDestination', client_id=client['id'], destination_id=0, json=True) }}".replace('destination_id=0','destination_id='+dest.id)}"
            data-update-url="${"{{ url_for('clients.editDestination', client_id=client['id'], destination_id=0) }}".replace('destination_id=0','destination_id='+dest.id)}">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger delete-dest-btn"
            title="Delete destination"
            data-dest-id="${dest.id}"
            data-delete-url="${"{{ url_for('clients.deleteDestination', client_id=client['id'], destination_id=0) }}".replace('destination_id=0','destination_id='+dest.id)}">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>`;

    const tbody = document.querySelector('#destinationsTable tbody');
    if (tbody.querySelector('.text-muted')) tbody.innerHTML = '';
    tbody.insertAdjacentHTML('afterbegin', rowHTML);
    bindDestinationHandlers(tbody);
    (bootstrap.Modal.getInstance(addDestinationModal) || new bootstrap.Modal(addDestinationModal)).hide();
    form.reset();
    toggleAddClusters();
    showAlert('Destination added successfully.');
  } catch (err) {
    showAlert('Failed to add destination: ' + err.message, 'danger');
  } finally {
    btn.disabled = false; spinner.classList.add('d-none');
  }
});

// ======= Delete destination =======
function bindDestinationDelete(root=document){
  root.querySelectorAll('.delete-dest-btn').forEach(btn => {
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-dest-id');
      const url = btn.getAttribute('data-delete-url');
      if (!confirm(`Delete destination #${id}? This cannot be undone.`)) return;
      btn.disabled = true;
      try {
        const res = await fetch(url, { method:'DELETE', headers: window._commonHeaders });
        const data = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
        document.getElementById(`dest-row-${id}`)?.remove();
        const tbody = document.querySelector('#destinationsTable tbody');
        if (tbody && !tbody.querySelector('tr')) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No destinations yet.</td></tr>`;
        }
        showAlert(`Destination #${id} deleted successfully.`);
      } catch (err) {
        showAlert('Failed to delete destination: ' + err.message, 'danger');
      } finally { btn.disabled = false; }
    };
  });
}

// ======= View / Edit destination =======
const destinationDetailsModal = document.getElementById('destinationDetailsModal');
const editDestinationForm = document.getElementById('editDestinationForm');

function fillDestinationDetails(d){
  document.getElementById('vd_id').textContent = d.id ?? '';
  document.getElementById('vd_type').textContent = d.type || '-';
  document.getElementById('vd_target').textContent = formatDestTarget(d);
  document.getElementById('vd_active').innerHTML = activeBadge(d.active);
  document.getElementById('vd_created_at').textContent = d.created_at ? String(d.created_at).slice(0,10) : '-';
  document.getElementById('vd_options').textContent = pretty(d.options_json ?? d.options ?? null) || '—';
}
function fillDestinationEdit(d, updateUrl){
  document.getElementById('vdf_id').value = d.id ?? '';
  document.getElementById('vdf_type').value = (d.type || 'other');
  document.getElementById('vdf_active').checked = !!(d.active===true || d.active===1 || d.active==="1" || d.active==="true");

  document.getElementById('vdf_host').value = d.host || '';
  document.getElementById('vdf_port').value = (d.port ?? '') || '';
  document.getElementById('vdf_database_name').value = d.database_name || '';
  document.getElementById('vdf_username').value = d.username || '';
  document.getElementById('vdf_password').value = ''; // never preload secrets
  document.getElementById('vdf_uri').value = d.uri || '';
  document.getElementById('vdf_options_json').value = pretty(d.options_json ?? d.options ?? null);
  toggleEditClusters();

  editDestinationForm.dataset.updateUrl = updateUrl;
}
document.getElementById('vdf_type').addEventListener('change', toggleEditClusters);

function bindDestinationView(root=document){
  root.querySelectorAll('.view-dest-btn').forEach(btn=>{
    btn.onclick = async ()=>{
      const viewUrl = btn.getAttribute('data-view-url');
      const updateUrl = btn.getAttribute('data-update-url');
      try {
        const res = await fetch(viewUrl, { headers: window._commonHeaders });
        const data = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
        const d = data.destination || data;
        fillDestinationDetails(d);
        fillDestinationEdit(d, updateUrl);
        new bootstrap.Modal(destinationDetailsModal).show();
      } catch (err) {
        showAlert('Failed to load destination: ' + err.message, 'danger');
      }
    };
  });
}

function bindDestinationHandlers(root=document){
  bindDestinationDelete(root);
  bindDestinationView(root);
}
bindDestinationHandlers(document);

// Save edits
editDestinationForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const btn = document.getElementById('vdf_saveBtn');
  const spinner = btn.querySelector('.spinner-border');
  btn.disabled = true; spinner.classList.remove('d-none');

  try {
    const type = document.getElementById('vdf_type').value;
    const payload = {
      type,
      active: !!document.getElementById('vdf_active').checked,
      host: document.getElementById('vdf_host').value.trim() || null,
      port: (document.getElementById('vdf_port').value.trim() || '') === '' ? null : parseInt(document.getElementById('vdf_port').value,10),
      database_name: document.getElementById('vdf_database_name').value.trim() || null,
      username: document.getElementById('vdf_username').value.trim() || null,
      // Send password only if provided (server keeps existing when omitted/empty)
      password: document.getElementById('vdf_password').value || undefined,
      uri: document.getElementById('vdf_uri').value.trim() || null,
      options_json: safeJsonParse(document.getElementById('vdf_options_json').value)
    };
    const url = editDestinationForm.dataset.updateUrl;
    const res = await fetch(url, { method:'PUT', headers: window._commonHeaders, body: JSON.stringify(payload) });
    const data = await res.json().catch(()=>({}));
    if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);

    const updated = data.destination || { id: document.getElementById('vdf_id').value, ...payload };
    // Update details pane
    fillDestinationDetails(updated);

    // Update row
    const row = document.getElementById(`dest-row-${updated.id}`);
    if (row) {
      if (updated.type !== undefined) row.querySelector('.dest-type').textContent = updated.type || '-';
      row.querySelector('.dest-target').textContent = formatDestTarget(updated);
      row.querySelector('.dest-active').innerHTML = activeBadge(updated.active);
    }

    showAlert('Destination updated successfully.');
    document.querySelector('#vd-tab-details').click();
  } catch (err) {
    showAlert('Failed to update destination: ' + err.message, 'danger');
  } finally {
    btn.disabled = false; spinner.classList.add('d-none');
  }
});

// Initialize clusters for add modal on show
addDestinationModal.addEventListener('show.bs.modal', ()=> {
  toggleAddClusters();
});
</script>

{% endblock %}
